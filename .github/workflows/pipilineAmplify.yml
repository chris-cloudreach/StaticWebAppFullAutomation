name: Team 3 static website challenge
on: [ push ] 
jobs:
  terraform_deployment_of_APIGW_COGNITO_DDB_LAMBDA:
    runs-on: ubuntu-latest
    steps: # The list of steps to take for executionnn
      - name: Authenticate with AWS
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2

      - name: Clone your code in the pipeline
        uses: actions/checkout@v2

      - name: Terraform setup
        uses: hashicorp/setup-terraform@v1

      - name: read config.js file 
        id: readConfig 
        run: |
          echo "echo the working directory below"
          pwd
          echo "Reading the config file now below"
          cat ./js/config.js
                         
        continue-on-error: true
        
      - name: Init
        id: init
        run: terraform init

      # - name: Plan
      #   id: plan
      #   run: terraform plan 
      #   continue-on-error: true

      - name: Apply
        id: apply
        run: terraform apply --auto-approve
        continue-on-error: true

      - name: Manipulating userpoolid 
        id: userpolID
        run: |
          terraform output userPoolId | cut -d'"' -f 2 > ~/userPoolId.txt
          echo "printing out the text file"
          cat ~/userPoolId.txt
          echo "manipulate"
          uu=$(cat ~/userPoolId.txt)
          echo "$uu" > ~/userPoolId.txt
          echo "checking userpool id oo"
          cat ~/userPoolId.txt
          
        continue-on-error: true

      # - name: Manipulating userpoolid 
      #   id: userpolID
      #   run: |
      #     terraform output userPoolId > ~/userPoolId.txt
      #     echo "checking userpool id"
      #     cat ~/userPoolId.txt
      #     sed -i -e "s/xyz/:/" ~/userPoolId.txt
      #     echo "checking replacement in userpool id"
      #     cat ~/userPoolId.txt
      #   continue-on-error: true

      - name: Edit userpool in config js file 
        id: editConfig
        run: |
          uid=$(cat ~/userPoolId.txt)
          sed -i -e "s/xyz/$uid/" ./js/config.js
          cat ./js/config.js
        continue-on-error: true

      - name: Build config js file 
        id: buildConfig
        run: |
          echo "building my file"
          uid=$(cat ~/userPoolId.txt)
          echo "userPoolId: " >> ./js/config2.js
          echo "$uid" >> ./js/config2.js
          echo " printing our config file"
          cat ./js/config2.js
        continue-on-error: true

      # - name: Build config js file 
      #   id: buildConfig
      #   run: |
      #     echo "building my file"
      #     uid=$(cat ~/userPoolId.txt)
      #     sed -e "s/xyz/$uid/" ./js/config.js
      #     cat ./js/config2.js
      #   continue-on-error: true


     